# .github/workflows/drift-detection.yml
name: Drift Detection

on:
  schedule:
    - cron: '0 */6 * * *'   # Every 6 hours
  workflow_dispatch:          # Manual trigger

permissions:
  id-token: write            # OIDC for AWS
  contents: read
  issues: write              # Create issue on blocking drift

env:
  ENVIRONMENT: production
  AWS_REGION: us-east-1

jobs:
  detect-drift:
    runs-on: ubuntu-latest
    steps:

      # â”€â”€ setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install -g pnpm@8
          pnpm install --frozen-lockfile

      # â”€â”€ baseline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download baseline from S3
        id: baseline
        run: |
          chmod +x scripts/load-baseline.sh
          set +e
          ./scripts/load-baseline.sh "${{ env.ENVIRONMENT }}" baseline.json
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=downloaded" >> "$GITHUB_OUTPUT"
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "status=created" >> "$GITHUB_OUTPUT"
            echo "::notice::Initial baseline created and uploaded â€” skipping drift check"
          else
            echo "status=failed" >> "$GITHUB_OUTPUT"
            echo "::error::Baseline loading failed with exit code $EXIT_CODE"
            exit 1
          fi

      # â”€â”€ drift analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run drift detection
        if: steps.baseline.outputs.status == 'downloaded'
        id: drift
        env:
          NONCE_PARAM_NAME: guardian/${{ env.ENVIRONMENT }}/redaction/nonce/v1
          FP_TABLE_NAME: mirror-dissonance-${{ env.ENVIRONMENT }}-fp-events
          CONSENT_TABLE_NAME: mirror-dissonance-${{ env.ENVIRONMENT }}-consent
          BLOCK_COUNTER_TABLE_NAME: mirror-dissonance-${{ env.ENVIRONMENT }}-block-counter
        run: |
          pnpm --filter @mirror-dissonance/cli run start drift \
            --baseline baseline.json \
            --output drift-report.json

          OUTCOME=$(jq -r '.machinedecision.outcome // .machineDecision.outcome // "unknown"' drift-report.json)
          echo "outcome=${OUTCOME}" >> "$GITHUB_OUTPUT"

          FINDING_COUNT=$(jq '.items | length' drift-report.json)
          echo "findings=${FINDING_COUNT}" >> "$GITHUB_OUTPUT"

      # â”€â”€ upload report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload drift report
        if: steps.baseline.outputs.status == 'downloaded'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-${{ github.run_id }}
          path: drift-report.json
          retention-days: 90

      # â”€â”€ create issue on blocking drift â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create issue on blocking drift
        if: steps.drift.outputs.outcome == 'block'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('drift-report.json', 'utf8'));
            const items = report.items || [];
            const violations = items
              .filter(item => item.severity === 'critical' || item.severity === 'high')
              .map(item => `- **${item.severity}**: ${item.title} (\`${item.ruleid || item.ruleId}\`)`)
              .join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Drift Detection: Blocking Violations Found',
              labels: ['drift-detection', 'priority-high'],
              body: [
                '## Drift Detection Alert',
                '',
                `**Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                `**Outcome:** \`block\``,
                `**Findings:** ${items.length}`,
                '',
                '### Critical/High Violations',
                violations || '_None classified as critical/high_',
                '',
                '### Action Required',
                '1. Review the drift report artifact attached to the workflow run',
                '2. Determine if changes are intentional or unauthorized',
                '3. If intentional: update the baseline with `scripts/load-baseline.sh`',
                '4. If unauthorized: investigate and revert',
              ].join('\n'),
            });

      # â”€â”€ fail the workflow on block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Evaluate drift decision
        if: steps.baseline.outputs.status == 'downloaded'
        run: |
          OUTCOME="${{ steps.drift.outputs.outcome }}"
          FINDINGS="${{ steps.drift.outputs.findings }}"

          if [ "${OUTCOME}" = "block" ]; then
            echo "::error::Drift detection found blocking violations (${FINDINGS} findings)"
            exit 1
          elif [ "${OUTCOME}" = "warn" ]; then
            echo "::warning::Drift detection found warnings (${FINDINGS} findings)"
          else
            echo "âœ… No drift detected"
          fi

      # â”€â”€ summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Post run summary
        if: always()
        run: |
          echo "## Drift Detection Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          STATUS="${{ steps.baseline.outputs.status }}"
          if [ "${STATUS}" = "created" ]; then
            echo "ðŸ†• **Initial baseline created** â€” no drift comparison performed." >> "$GITHUB_STEP_SUMMARY"
          elif [ "${STATUS}" = "downloaded" ] && [ -f drift-report.json ]; then
            OUTCOME=$(jq -r '.machinedecision.outcome // .machineDecision.outcome // "unknown"' drift-report.json)
            TOTAL=$(jq '.items | length' drift-report.json)
            echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| Outcome | \`${OUTCOME}\` |" >> "$GITHUB_STEP_SUMMARY"
            echo "| Findings | ${TOTAL} |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            if [ "${TOTAL}" != "0" ]; then
              echo "### Findings" >> "$GITHUB_STEP_SUMMARY"
              jq -r '.items[] | "- **\(.severity)**: \(.title)"' drift-report.json >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "âŒ **Baseline loading failed**" >> "$GITHUB_STEP_SUMMARY"
          fi
