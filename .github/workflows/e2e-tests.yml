name: E2E Integration Tests

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1' # Weekly Monday at 6 AM UTC

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: staging
  NODE_VERSION: '20'

jobs:
  e2e-tests:
    name: Run E2E Tests (Staging)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-E2ETests
      
      - name: Verify AWS identity
        run: |
          aws sts get-caller-identity
          echo "✓ Authenticated to AWS via OIDC"
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
      
      - name: Verify staging infrastructure
        run: |
          echo "Checking staging DynamoDB tables..."
          TABLES=$(aws dynamodb list-tables --region ${{ env.AWS_REGION }} \
            --query "TableNames[?contains(@, 'mirror-dissonance-staging')]" \
            --output text)
          if [ -z "$TABLES" ]; then
            echo "::error::No staging tables found — deploy staging first"
            exit 1
          fi
          echo "✓ Staging tables: $TABLES"

          echo "Checking SSM nonce..."
          aws ssm get-parameter \
            --name /guardian/staging/redaction_nonce_v1 \
            --region ${{ env.AWS_REGION }} \
            --query 'Parameter.Version' --output text || {
              echo "::error::SSM nonce not found"
              exit 1
            }
          echo "✓ SSM nonce accessible"
      
      - name: Run package E2E tests
        run: |
          pnpm test -- src/__tests__/e2e/ --testTimeout=30000 --verbose --no-coverage
        working-directory: packages/mirror-dissonance
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          FP_TABLE: mirror-dissonance-staging-fp-events
          CONSENT_TABLE: mirror-dissonance-staging-consent
          BLOCK_COUNTER_TABLE: mirror-dissonance-staging-block-counter
          NONCE_PARAM: /guardian/staging/redaction_nonce_v1

      - name: Run full-cycle E2E test
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        run: |
          cd e2e
          pnpm install --frozen-lockfile
          pnpm test -- full-cycle.test.ts --testTimeout=600000 --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.E2E_GITHUB_TOKEN }}
          E2E_TEST_OWNER: MultiplicityFoundation
          E2E_TEST_REPO: Phase-Mirror-Test
          AWS_REGION: ${{ env.AWS_REGION }}
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            packages/mirror-dissonance/coverage/
            packages/mirror-dissonance/test-results/
          retention-days: 30
      
      - name: Report test summary
        if: always()
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "Region: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All E2E integration tests passed" >> $GITHUB_STEP_SUMMARY
