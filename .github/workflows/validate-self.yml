name: Self-Validation (Mirror Reflects Itself)

on:
  pull_request:
    branches: [main]
    paths:
      - 'packages/**'
      - '.github/workflows/**'
      - '.phase-mirror.yml'
      - 'docs/adr/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build core library
        run: pnpm --filter @mirror-dissonance/core build

      - name: Build CLI
        run: pnpm --filter @mirror-dissonance/cli build

      - name: Initialize config (if missing)
        run: |
          if [ ! -f .phase-mirror.yml ]; then
            echo "⚠️  No .phase-mirror.yml found, initializing with standard template"
            pnpm --filter @mirror-dissonance/cli exec oracle init --template standard
          fi

      - name: Run self-validation
        id: validate
        run: |
          set +e
          pnpm --filter @mirror-dissonance/cli exec oracle validate --strict --format json --output validation-report.json
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ "$EXIT_CODE" -eq 2 ]; then
            echo "::warning::Self-validation completed in degraded mode (exit 2). Some infrastructure unavailable."
            exit 0  # Degraded is non-blocking per ADR-030/031
          fi
          exit $EXIT_CODE

      - name: Comment on PR (if validation failed)
        if: failure() && steps.validate.outputs.exit_code == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report;
            try {
              report = JSON.parse(fs.readFileSync('validation-report.json', 'utf8'));
            } catch {
              report = { findings: [{ ruleId: 'UNKNOWN', title: 'Validation report unavailable', severity: 'critical' }] };
            }

            const body = `## ❌ Self-Validation Failed

            **The mirror detected a governance violation in its own codebase.**

            Exit Code: \`${process.env.EXIT_CODE}\`

            ### Violations
            ${report.findings.map(f => \`- **\${f.ruleId}**: \${f.title} (\\\`\${f.severity}\\\`)\`).join('\n')}

            **Governance rules apply to Phase Mirror itself.** Fix violations before merging.

            See: [ADR-031](https://github.com/MultiplicityFoundation/Phase-Mirror/blob/main/docs/adr/ADR-031-self-validation-ci-gate.md)
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
        env:
          EXIT_CODE: ${{ steps.validate.outputs.exit_code }}

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: self-validation-report
          path: validation-report.json
          retention-days: 30
          if-no-files-found: ignore

  governance-override-check:
    runs-on: ubuntu-latest
    needs: validate
    if: failure()
    steps:
      - name: Check for override label
        uses: actions/github-script@v7
        with:
          script: |
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const hasOverride = labels.some(l => l.name === 'override-governance');

            if (!hasOverride) {
              core.setFailed(
                'Self-validation failed and no override-governance label present. ' +
                'Requires governance owner approval per ADR-031.'
              );
            } else {
              core.notice('⚠️ Governance override label detected. Override will be logged to audit trail.');
            }
