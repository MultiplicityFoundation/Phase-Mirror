name: Schema Sync Check

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6am UTC
  workflow_dispatch:
  push:
    paths:
      - 'packages/mirror-dissonance/schemas/**'

jobs:
  check-schema-drift:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout OSS repo
        uses: actions/checkout@v4

      - name: Compute OSS schema hash
        id: oss-hash
        run: |
          HASH=$(sha256sum packages/mirror-dissonance/schemas/dissonance-report.schema.json | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "OSS schema hash: $HASH"

      - name: Fetch Pro repo schema (if applicable)
        id: pro-hash
        env:
          GH_TOKEN: ${{ secrets.PRO_REPO_TOKEN }}
        run: |
          # Skip if Pro repo doesn't exist yet
          if ! gh api repos/${{ github.repository_owner }}/mirror-dissonance-pro >/dev/null 2>&1; then
            echo "Pro repo not found - skipping"
            echo "hash=SKIP" >> $GITHUB_OUTPUT
            exit 0
          fi

          curl -H "Authorization: token $GH_TOKEN" \
            -o pro-schema.json \
            https://raw.githubusercontent.com/${{ github.repository_owner }}/mirror-dissonance-pro/main/schemas/dissonance-report.schema.json

          HASH=$(sha256sum pro-schema.json | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Pro schema hash: $HASH"

      - name: Compare hashes
        if: steps.pro-hash.outputs.hash != 'SKIP'
        run: |
          if [ "${{ steps.oss-hash.outputs.hash }}" != "${{ steps.pro-hash.outputs.hash }}" ]; then
            echo "::error::Schema drift detected between OSS and Pro repos"
            echo "OSS: ${{ steps.oss-hash.outputs.hash }}"
            echo "Pro: ${{ steps.pro-hash.outputs.hash }}"
            exit 1
          fi
          echo "âœ… Schemas in sync"

      - name: Create issue on drift
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Schema Drift Detected: OSS â†” Pro',
              body: `Schema hash mismatch detected:\n\n- **OSS**: \`${{ steps.oss-hash.outputs.hash }}\`\n- **Pro**: \`${{ steps.pro-hash.outputs.hash }}\`\n\nAction required: Sync schemas or update Pro to match OSS.`,
              labels: ['schema-drift', 'priority-high']
            });
